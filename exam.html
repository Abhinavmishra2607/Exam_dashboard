<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAT & SSC CGL Progress Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, addDoc, setDoc, deleteDoc, doc, serverTimestamp, orderBy, query, limit, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        setLogLevel('debug');
        
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "dummy-api-key",
            authDomain: "dummy-auth-domain",
            projectId: "dummy-project-id"
        };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const progressData = {
            studyPlan: [],
            mockAnalysis: [],
            topicAccuracy: []
        };
        
        let userId;

        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `p-4 mt-4 rounded-md text-sm text-center ${type === 'error' ? 'bg-red-100 text-red-700' : 'bg-green-100 text-green-700'}`;
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000);
        }

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                document.getElementById('loading-indicator').classList.add('hidden');
                document.getElementById('main-container').classList.remove('hidden');
                startFirestoreListeners();
            } else {
                try {
                    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                } catch (error) {
                    console.error("Authentication failed:", error);
                    showMessage('Failed to log in. Please try again.', 'error');
                }
            }
        });

        function startFirestoreListeners() {
            const studyPlanRef = collection(db, `/artifacts/${appId}/users/${userId}/study_plan`);
            const mockAnalysisRef = collection(db, `/artifacts/${appId}/users/${userId}/mock_analysis`);
            const topicAccuracyRef = collection(db, `/artifacts/${appId}/users/${userId}/topic_accuracy`);
            
            onSnapshot(studyPlanRef, (snapshot) => {
                progressData.studyPlan = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateStudyPlanTable();
                populateDashboard();
            });

            onSnapshot(mockAnalysisRef, (snapshot) => {
                progressData.mockAnalysis = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateMockAnalysisTable();
                populateDashboard();
                renderPerformanceChart('cat');
            });
            
            onSnapshot(topicAccuracyRef, (snapshot) => {
                progressData.topicAccuracy = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateTopicAccuracyTable();
                populateDashboard();
            });
        }
        
        window.saveMockData = async (event) => {
            event.preventDefault();
            const form = document.getElementById('mock-form');
            const docId = document.getElementById('mockDocId').value;
            const examType = form.querySelector('#mockExamType').value;
            const overallPercentile = form.querySelector('#overallPercentile').value;
            const overallRank = form.querySelector('#overallRank').value;
            
            let mockData = {
                exam: examType,
                date: new Date().toISOString().slice(0, 10),
                timestamp: serverTimestamp(),
                overall: {
                    percentile: parseFloat(overallPercentile) || 0,
                    rank: overallRank,
                    totalScore: 0,
                    totalPossibleScore: 0,
                    accuracy: 0,
                }
            };
            
            let overallScore = 0;

            if (examType === 'CAT') {
                const sections = ['varc', 'qa', 'lr'];
                sections.forEach(section => {
                    const total = parseInt(form.querySelector(`#${section}TotalQuestions`).value) || 0;
                    const attempted = parseInt(form.querySelector(`#${section}Attempted`).value) || 0;
                    const correct = parseInt(form.querySelector(`#${section}Correct`).value) || 0;
                    const incorrect = parseInt(form.querySelector(`#${section}Incorrect`).value) || 0;
                    const skipped = parseInt(form.querySelector(`#${section}Skipped`).value) || 0;
                    const score = parseInt(form.querySelector(`#${section}Score`).value) || 0;
                    const accuracy = parseInt(form.querySelector(`#${section}Accuracy`).value) || 0;
                    const scorePercentage = parseInt(form.querySelector(`#${section}ScorePercentage`).value) || 0;

                    mockData[section] = { totalQuestions: total, attempted, correct, incorrect, skipped, score, accuracy, scorePercentage };
                    overallScore += score;
                });
                
                mockData.overall.totalScore = overallScore;
                mockData.overall.totalPossibleScore = 198;
                mockData.overall.accuracy = parseInt(form.querySelector('#catOverallAccuracy').value) || 0;

            } else { // SSC CGL
                const tier = form.querySelector('#sscTier').value;
                const sections = ['gk', 'varc', 'qa', 'lr'];
                mockData.tier = tier;
                mockData.overall.totalPossibleScore = (tier === 'tier1' ? 200 : 210);
                
                sections.forEach(section => {
                    const total = parseInt(form.querySelector(`#ssc_${section}TotalQuestions_${tier}`).value) || 0;
                    const attempted = parseInt(form.querySelector(`#ssc_${section}Attempted_${tier}`).value) || 0;
                    const correct = parseInt(form.querySelector(`#ssc_${section}Correct_${tier}`).value) || 0;
                    const incorrect = parseInt(form.querySelector(`#ssc_${section}Incorrect_${tier}`).value) || 0;
                    const skipped = parseInt(form.querySelector(`#ssc_${section}Skipped_${tier}`).value) || 0;
                    const score = parseInt(form.querySelector(`#ssc_${section}Score_${tier}`).value) || 0;
                    const accuracy = parseInt(form.querySelector(`#ssc_${section}Accuracy_${tier}`).value) || 0;
                    const scorePercentage = parseInt(form.querySelector(`#ssc_${section}ScorePercentage_${tier}`).value) || 0;

                    mockData[section] = { totalQuestions: total, attempted, correct, incorrect, skipped, score, accuracy, scorePercentage };
                    overallScore += score;
                });

                mockData.overall.totalScore = overallScore;
                mockData.overall.accuracy = parseInt(form.querySelector('#sscOverallAccuracy').value) || 0;
            }

            try {
                if(docId) {
                    await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/mock_analysis`, docId), mockData);
                    showMessage('Mock test data updated successfully!');
                    closeModal();
                } else {
                    await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/mock_analysis`), mockData);
                    showMessage('Mock test data saved successfully!');
                    document.getElementById('mock-form').reset();
                }
            } catch (e) {
                console.error(e);
                showMessage('Error saving data. Please check your inputs.', 'error');
            }
        };

        window.saveStudyData = async (event) => {
            event.preventDefault();
            const docId = document.getElementById('studyDocId').value;
            const topic = document.getElementById('studyTopic').value;
            const subject = document.getElementById('studySubject').value;
            const week = document.getElementById('studyWeek').value;
            const status = document.getElementById('studyStatus').value;

            if (!topic || !subject || !week || !status) {
                showMessage('Please fill all required fields for Study Plan.', 'error');
                return;
            }

            try {
                if (docId) {
                    await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/study_plan`, docId), {
                        week: week,
                        subject: subject,
                        topic: topic,
                        status: status,
                        timestamp: serverTimestamp()
                    });
                    showMessage('Study plan data updated successfully!');
                    closeModal();
                } else {
                    await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/study_plan`), {
                        week: week,
                        subject: subject,
                        topic: topic,
                        status: status,
                        timestamp: serverTimestamp()
                    });
                    showMessage('Study plan data saved successfully!');
                    document.getElementById('study-form').reset();
                }
            } catch (e) {
                showMessage('Error saving data.', 'error');
            }
        };

        window.saveTopicAccuracy = async (event) => {
             event.preventDefault();
             const docId = document.getElementById('accuracyDocId').value;
             const topic = document.getElementById('accuracyTopic').value;
             const attempted = parseInt(document.getElementById('accuracyAttempted').value) || 0;
             const correct = parseInt(document.getElementById('accuracyCorrect').value) || 0;

             if (!topic || attempted <= 0 || correct < 0) {
                showMessage('Please fill all required fields for Topic Accuracy and ensure numbers are valid.', 'error');
                return;
             }

             const accuracy = (correct / attempted) * 100;
             try {
                 if (docId) {
                     await setDoc(doc(db, `/artifacts/${appId}/users/${userId}/topic_accuracy`, docId), {
                         topic: topic,
                         attempted: attempted,
                         correct: correct,
                         accuracy: accuracy,
                         timestamp: serverTimestamp()
                     });
                     showMessage('Topic accuracy data updated successfully!');
                     closeModal();
                 } else {
                     await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/topic_accuracy`), {
                         topic: topic,
                         attempted: attempted,
                         correct: correct,
                         accuracy: accuracy,
                         timestamp: serverTimestamp()
                     });
                     showMessage('Topic accuracy data saved successfully!');
                     document.getElementById('accuracy-form').reset();
                 }
             } catch (e) {
                 showMessage('Error saving data.', 'error');
             }
         };

        window.editStudyPlan = (id) => {
            const item = progressData.studyPlan.find(d => d.id === id);
            if (item) {
                document.getElementById('studyDocId').value = item.id;
                document.getElementById('studyTopic').value = item.topic;
                document.getElementById('studySubject').value = item.subject;
                document.getElementById('studyWeek').value = item.week;
                document.getElementById('studyStatus').value = item.status;
                document.getElementById('study-form-title').textContent = 'Edit Study Plan Entry';
                document.getElementById('save-study-btn').textContent = 'Update Study Data';
                openModal('study_plan');
            }
        };
        
        window.editTopicAccuracy = (id) => {
            const item = progressData.topicAccuracy.find(d => d.id === id);
            if (item) {
                document.getElementById('accuracyDocId').value = item.id;
                document.getElementById('accuracyTopic').value = item.topic;
                document.getElementById('accuracyAttempted').value = item.attempted;
                document.getElementById('accuracyCorrect').value = item.correct;
                document.getElementById('accuracy-form-title').textContent = 'Edit Topic Accuracy';
                document.getElementById('save-accuracy-btn').textContent = 'Update Accuracy Data';
                openModal('topic_accuracy');
            }
        };
        
        window.editMockAnalysis = (id) => {
            const item = progressData.mockAnalysis.find(d => d.id === id);
            if (item) {
                const form = document.getElementById('mock-form');
                form.querySelector('#mockDocId').value = item.id;
                form.querySelector('#mockExamType').value = item.exam;
                
                toggleMockForm(item.exam);
                if (item.exam === 'SSC CGL') {
                    form.querySelector('#sscTier').value = item.tier;
                    toggleSSCTier(item.tier);
                }
                
                // Now, populate the fields that are guaranteed to be visible
                form.querySelector('#overallPercentile').value = item.overall.percentile;
                form.querySelector('#overallRank').value = item.overall.rank;

                if (item.exam === 'CAT') {
                    const sections = ['varc', 'qa', 'lr'];
                    sections.forEach(section => {
                        if (form.querySelector(`#${section}TotalQuestions`)) form.querySelector(`#${section}TotalQuestions`).value = item[section].totalQuestions;
                        if (form.querySelector(`#${section}Attempted`)) form.querySelector(`#${section}Attempted`).value = item[section].attempted;
                        if (form.querySelector(`#${section}Correct`)) form.querySelector(`#${section}Correct`).value = item[section].correct;
                        if (form.querySelector(`#${section}Incorrect`)) form.querySelector(`#${section}Incorrect`).value = item[section].incorrect;
                        if (form.querySelector(`#${section}Skipped`)) form.querySelector(`#${section}Skipped`).value = item[section].skipped;
                        if (form.querySelector(`#${section}Score`)) form.querySelector(`#${section}Score`).value = item[section].score;
                        if (form.querySelector(`#${section}Accuracy`)) form.querySelector(`#${section}Accuracy`).value = item[section].accuracy;
                        if (form.querySelector(`#${section}ScorePercentage`)) form.querySelector(`#${section}ScorePercentage`).value = item[section].scorePercentage;
                    });
                } else { // SSC CGL
                    const tier = item.tier;
                    const sections = ['gk', 'varc', 'qa', 'lr'];
                     sections.forEach(section => {
                        if (form.querySelector(`#ssc_${section}TotalQuestions_${tier}`)) form.querySelector(`#ssc_${section}TotalQuestions_${tier}`).value = item[section].totalQuestions;
                        if (form.querySelector(`#ssc_${section}Attempted_${tier}`)) form.querySelector(`#ssc_${section}Attempted_${tier}`).value = item[section].attempted;
                        if (form.querySelector(`#ssc_${section}Correct_${tier}`)) form.querySelector(`#ssc_${section}Correct_${tier}`).value = item[section].correct;
                        if (form.querySelector(`#ssc_${section}Incorrect_${tier}`)) form.querySelector(`#ssc_${section}Incorrect_${tier}`).value = item[section].incorrect;
                        if (form.querySelector(`#ssc_${section}Skipped_${tier}`)) form.querySelector(`#ssc_${section}Skipped_${tier}`).value = item[section].skipped;
                        if (form.querySelector(`#ssc_${section}Score_${tier}`)) form.querySelector(`#ssc_${section}Score_${tier}`).value = item[section].score;
                        if (form.querySelector(`#ssc_${section}Accuracy_${tier}`)) form.querySelector(`#ssc_${section}Accuracy_${tier}`).value = item[section].accuracy;
                        if (form.querySelector(`#ssc_${section}ScorePercentage_${tier}`)) form.querySelector(`#ssc_${section}ScorePercentage_${tier}`).value = item[section].scorePercentage;
                    });
                }
                document.getElementById('mock-form-title').textContent = 'Edit Mock Test Entry';
                document.getElementById('save-mock-btn').textContent = 'Update Mock Data';
                openModal('mock_analysis');
            }
        };
        
        window.deleteData = async (id, collectionName) => {
            const confirmDelete = await showCustomConfirm(`Are you sure you want to delete this ${collectionName.replace('_', ' ')} entry?`);
            if (confirmDelete) {
                try {
                    await deleteDoc(doc(db, `/artifacts/${appId}/users/${userId}/${collectionName}`, id));
                    showMessage('Entry deleted successfully!');
                } catch (e) {
                    showMessage('Error deleting data.', 'error');
                }
            }
        };

        function showCustomConfirm(message) {
            return new Promise((resolve) => {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="p-6 bg-white rounded-lg shadow-xl max-w-sm mx-auto">
                        <p class="text-lg font-semibold mb-4 text-center">${message}</p>
                        <div class="flex justify-center space-x-4">
                            <button id="confirm-yes" class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Delete</button>
                            <button id="confirm-no" class="px-4 py-2 bg-gray-300 text-gray-800 rounded-md hover:bg-gray-400 transition-colors">Cancel</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);

                document.getElementById('confirm-yes').onclick = () => {
                    modal.remove();
                    resolve(true);
                };
                document.getElementById('confirm-no').onclick = () => {
                    modal.remove();
                    resolve(false);
                };
            });
        }
        
        window.openModal = (formType) => {
            document.getElementById('data-entry-modal').classList.remove('hidden');
            document.getElementById('study-form').reset();
            document.getElementById('accuracy-form').reset();
            document.getElementById('mock-form').reset();

            document.getElementById('study-form-title').textContent = 'Add Study Plan Entry';
            document.getElementById('save-study-btn').textContent = 'Save Study Data';
            document.getElementById('accuracy-form-title').textContent = 'Add Topic Accuracy';
            document.getElementById('save-accuracy-btn').textContent = 'Save Accuracy Data';
            document.getElementById('mock-form-title').textContent = 'Add Mock Test Entry';
            document.getElementById('save-mock-btn').textContent = 'Save Mock Data';

            const studyFormContainer = document.getElementById('study-form-container');
            const accuracyFormContainer = document.getElementById('accuracy-form-container');
            const mockFormContainer = document.getElementById('mock-form-container');

            studyFormContainer.classList.add('hidden');
            accuracyFormContainer.classList.add('hidden');
            mockFormContainer.classList.add('hidden');
            document.getElementById('data-entry-content').classList.remove('grid', 'md:grid-cols-2', 'gap-8');

            if (formType === 'study_plan') {
                studyFormContainer.classList.remove('hidden');
            } else if (formType === 'topic_accuracy') {
                accuracyFormContainer.classList.remove('hidden');
            } else if (formType === 'mock_analysis') {
                mockFormContainer.classList.remove('hidden');
            } else { // 'all'
                studyFormContainer.classList.remove('hidden');
                accuracyFormContainer.classList.remove('hidden');
                mockFormContainer.classList.remove('hidden');
                document.getElementById('data-entry-content').classList.add('grid', 'md:grid-cols-2', 'gap-8');
            }
        };

        window.closeModal = () => {
            document.getElementById('data-entry-modal').classList.add('hidden');
        };
        
        const syllabusData = {
            cat: {
                name: 'CAT (Common Admission Test)',
                subjects: [
                    {
                        name: 'Verbal Ability & Reading Comprehension (VARC)',
                        topicGroups: [
                            { heading: 'Reading & Comprehension', topics: ['Reading Comprehension', 'Para Jumbles', 'Para Summary', 'Odd One Out']},
                            { heading: 'Verbal Ability', topics: ['Sentence Correction', 'Fill in the Blanks', 'Vocabulary']}
                        ]
                    },
                    {
                        name: 'Data Interpretation & Logical Reasoning (DILR)',
                        topicGroups: [
                            { heading: 'Data Interpretation', topics: ['Tables', 'Bar Graphs', 'Pie Charts']},
                            { heading: 'Logical Reasoning', topics: ['Puzzles', 'Seating Arrangements', 'Blood Relations', 'Visual Reasoning', 'Caselets']}
                        ]
                    },
                    {
                        name: 'Quantitative Aptitude (QA)',
                        topicGroups: [
                            { heading: 'Arithmetic', topics: ['Percentage', 'Profit & Loss', 'Simple & Compound Interest', 'Ratio & Proportion', 'Time & Work', 'Speed, Time & Distance', 'Averages', 'Mixtures & Allegations']},
                            { heading: 'Algebra', topics: ['Linear & Quadratic Equations', 'Polynomials', 'Functions', 'Logarithms', 'Progressions (AP, GP, HP)']},
                            { heading: 'Geometry', topics: ['Lines & Angles', 'Triangles', 'Quadrilaterals', 'Circles', 'Polygons', 'Mensuration']},
                            { heading: 'Number Systems', topics: ['Divisibility Rules', 'Remainders', 'HCF & LCM', 'Cyclicity', 'Unit Digit']},
                            { heading: 'Modern Math', topics: ['Permutations & Combinations', 'Probability', 'Set Theory']}
                        ]
                    }
                ]
            },
            ssc_cgl: {
                name: 'SSC CGL (Staff Selection Commission)',
                subjects: [
                    {
                        name: 'Quantitative Aptitude',
                        topicGroups: [
                            { heading: 'Arithmetic', topics: ['Percentage', 'Profit & Loss', 'Simple & Compound Interest', 'Ratio & Proportion', 'Averages', 'Time & Work', 'Time, Speed & Distance', 'Partnerships']},
                            { heading: 'Algebra', topics: ['Basic Algebraic Identities', 'Surds & Indices', 'Linear & Quadratic Equations', 'Graphs of Linear Equations']},
                            { heading: 'Geometry & Mensuration', topics: ['Triangles & its Congruence and Similarity', 'Circles', 'Chords', 'Tangents', 'Angles subtended by Chords', 'Mensuration']},
                            { heading: 'Trigonometry', topics: ['Trigonometric Ratios', 'Complementary Angles', 'Heights & Distances']},
                            { heading: 'Number Systems', topics: ['Divisibility', 'Prime & Composite Numbers', 'HCF & LCM', 'Square & Cube Roots']},
                            { heading: 'Data Interpretation', topics: ['Bar Charts', 'Pie Charts', 'Line Graphs', 'Histograms']}
                        ]
                    },
                    {
                        name: 'English Language',
                        topicGroups: [
                            { heading: 'Core English', topics: ['Reading Comprehension', 'Error Spotting', 'Fill in the Blanks']},
                            { heading: 'Vocabulary & Grammar', topics: ['Synonyms & Antonyms', 'Spelling Test', 'Idioms & Phrases', 'One-word Substitution', 'Sentence Improvement']}
                        ]
                    },
                    {
                        name: 'General Intelligence & Reasoning',
                        topicGroups: [
                            { heading: 'Logical Reasoning', topics: ['Analogies', 'Classification', 'Series', 'Coding & Decoding', 'Syllogisms']},
                            { heading: 'Advanced Reasoning', topics: ['Non-verbal Reasoning', 'Puzzles', 'Blood Relations']}
                        ]
                    },
                    {
                        name: 'General Awareness',
                        topicGroups: [
                            { heading: 'Static GK', topics: ['History', 'Geography', 'Polity', 'Economics', 'General Science']},
                            { heading: 'Current Affairs', topics: ['National & International News', 'Awards & Honors', 'Sports', 'Economic Developments']}
                        ]
                    }
                ]
            }
        };

        function getAllTopics() {
            const topics = new Set();
            Object.values(syllabusData).forEach(exam => {
                exam.subjects.forEach(subject => {
                    subject.topicGroups.forEach(group => {
                        group.topics.forEach(topic => topics.add(topic));
                    });
                });
            });
            return Array.from(topics);
        }

        function populateTopicDatalist() {
            const datalist = document.getElementById('syllabus-topics');
            if (datalist) {
                datalist.innerHTML = '';
                const allTopics = getAllTopics().sort();
                allTopics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic;
                    datalist.appendChild(option);
                });
            }
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const views = {
                dashboard: document.getElementById('view-dashboard'),
                analysis: document.getElementById('view-analysis'),
                plan: document.getElementById('view-plan'),
                syllabus: document.getElementById('view-syllabus'),
            };

            const navButtons = {
                dashboard: document.getElementById('btn-dashboard'),
                analysis: document.getElementById('btn-analysis'),
                plan: document.getElementById('btn-plan'),
                syllabus: document.getElementById('btn-syllabus'),
            };

            window.switchView = (viewName) => {
                Object.values(views).forEach(v => v.classList.add('hidden'));
                Object.values(navButtons).forEach(b => b.classList.remove('active'));
                views[viewName].classList.remove('hidden');
                if (navButtons[viewName]) {
                    navButtons[viewName].classList.add('active');
                }
            }
            
            navButtons.dashboard.addEventListener('click', () => switchView('dashboard'));
            navButtons.analysis.addEventListener('click', () => switchView('analysis'));
            navButtons.plan.addEventListener('click', () => switchView('plan'));
            navButtons.syllabus.addEventListener('click', () => switchView('syllabus'));
            
            document.getElementById('btn-add-study-data').addEventListener('click', () => openModal('study_plan'));
            document.getElementById('btn-add-accuracy-data').addEventListener('click', () => openModal('topic_accuracy'));
            document.getElementById('btn-add-mock-data').addEventListener('click', () => {
                openModal('mock_analysis');
                toggleMockForm('CAT');
            });
            document.getElementById('add-data-btn').addEventListener('click', () => openModal('all'));
            document.getElementById('modal-close-btn').addEventListener('click', closeModal);

            renderPerformanceChart('cat');
            const chartBtnCat = document.getElementById('chart-btn-cat');
            const chartBtnSsc = document.getElementById('chart-btn-ssc');

            chartBtnCat.addEventListener('click', () => {
                renderPerformanceChart('cat');
                chartBtnCat.classList.add('bg-white', 'text-blue-700', 'shadow');
                chartBtnSsc.classList.remove('bg-white', 'text-blue-700', 'shadow');
                chartBtnSsc.classList.add('text-gray-600');
            });

             chartBtnSsc.addEventListener('click', () => {
                renderPerformanceChart('ssc');
                chartBtnSsc.classList.add('bg-white', 'text-blue-700', 'shadow');
                chartBtnCat.classList.remove('bg-white', 'text-blue-700', 'shadow');
                chartBtnCat.classList.add('text-gray-600');
            });
            
            const analysisBtnAll = document.getElementById('analysis-btn-all');
            const analysisBtnCat = document.getElementById('analysis-btn-cat');
            const analysisBtnSsc = document.getElementById('analysis-btn-ssc');

            analysisBtnAll.addEventListener('click', () => {
                populateMockAnalysisTable();
                analysisBtnAll.classList.add('bg-white', 'text-blue-700', 'shadow');
                analysisBtnCat.classList.remove('bg-white', 'text-blue-700', 'shadow');
                analysisBtnSsc.classList.remove('bg-white', 'text-blue-700', 'shadow');
                analysisBtnCat.classList.add('text-gray-600');
                analysisBtnSsc.classList.add('text-gray-600');
            });
            analysisBtnCat.addEventListener('click', () => {
                populateMockAnalysisTable('CAT');
                analysisBtnCat.classList.add('bg-white', 'text-blue-700', 'shadow');
                analysisBtnAll.classList.remove('bg-white', 'text-blue-700', 'shadow');
                analysisBtnSsc.classList.remove('bg-white', 'text-blue-700', 'shadow');
                analysisBtnAll.classList.add('text-gray-600');
                analysisBtnSsc.classList.add('text-gray-600');
            });
            analysisBtnSsc.addEventListener('click', () => {
                populateMockAnalysisTable('SSC CGL');
                analysisBtnSsc.classList.add('bg-white', 'text-blue-700', 'shadow');
                analysisBtnAll.classList.remove('bg-white', 'text-blue-700', 'shadow');
                analysisBtnCat.classList.remove('bg-white', 'text-blue-700', 'shadow');
                analysisBtnAll.classList.add('text-gray-600');
                analysisBtnCat.classList.add('text-gray-600');
            });
            
            renderSyllabus();
            populateTopicDatalist();

            document.getElementById('syllabus-search').addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                document.querySelectorAll('.syllabus-topic-item').forEach(li => {
                    const topicText = li.textContent.toLowerCase();
                    if (topicText.includes(searchTerm)) {
                        li.closest('.syllabus-topic-group-content').classList.remove('hidden');
                        li.closest('.syllabus-subject-content').classList.remove('hidden');
                        li.closest('details').open = true;
                        li.style.display = 'list-item';
                    } else {
                        li.style.display = 'none';
                    }
                });
            });
            document.getElementById('mockExamType').addEventListener('change', (e) => toggleMockForm(e.target.value));
            document.getElementById('sscTier').addEventListener('change', (e) => toggleSSCTier(e.target.value));
            
            const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
            if (initialAuthToken) {
                await signInWithCustomToken(auth, initialAuthToken);
            } else {
                await signInAnonymously(auth);
            }
            const sampleCATData = {
                exam: 'CAT',
                date: new Date().toISOString().slice(0, 10),
                timestamp: serverTimestamp(),
                overall: {
                    percentile: 98.7,
                    rank: '250',
                    totalScore: 156,
                    totalPossibleScore: 198,
                    accuracy: 90.1,
                },
                varc: {
                    totalQuestions: 24,
                    attempted: 22,
                    correct: 20,
                    incorrect: 2,
                    skipped: 2,
                    score: 58,
                    accuracy: 90.9,
                    scorePercentage: 80.5,
                },
                qa: {
                    totalQuestions: 22,
                    attempted: 20,
                    correct: 18,
                    incorrect: 2,
                    skipped: 2,
                    score: 52,
                    accuracy: 90.0,
                    scorePercentage: 78.8,
                },
                lr: {
                    totalQuestions: 20,
                    attempted: 18,
                    correct: 16,
                    incorrect: 2,
                    skipped: 2,
                    score: 46,
                    accuracy: 88.9,
                    scorePercentage: 76.7,
                },
            };
            const mockAnalysisRef = collection(db, `/artifacts/${appId}/users/${userId}/mock_analysis`);
            try {
                const existingDocs = await getDocs(query(mockAnalysisRef, where('exam', '==', 'CAT'), limit(1)));
                if (existingDocs.empty) {
                    await addDoc(mockAnalysisRef, sampleCATData);
                }
            } catch (e) {
                console.error("Error adding sample data: ", e);
            }
        });

        function populateDashboard() {
            const completedTopics = progressData.studyPlan.filter(d => d.status === 'Completed').length;
            document.getElementById('topics-completed').textContent = completedTopics;
            
            const catMocks = progressData.mockAnalysis.filter(d => d.exam === 'CAT');
            const avgCatPercentile = catMocks.length > 0 ? catMocks.reduce((sum, mock) => sum + parseFloat(mock.overall.percentile), 0) / catMocks.length : 0;
            document.getElementById('avg-cat-percentile').textContent = `${avgCatPercentile.toFixed(2)}%`;

            const sscMocks = progressData.mockAnalysis.filter(d => d.exam === 'SSC CGL');
            const avgSscScore = sscMocks.length > 0 ? sscMocks.reduce((sum, mock) => sum + mock.overall.totalScore, 0) / sscMocks.length : 0;
            document.getElementById('avg-ssc-score').textContent = avgSscScore.toFixed(0);

            const validAccuracyTopics = progressData.topicAccuracy.filter(d => d.attempted > 0);
            const totalAccuracy = validAccuracyTopics.length > 0 ? validAccuracyTopics.reduce((sum, topic) => sum + topic.accuracy, 0) / validAccuracyTopics.length : 0;
            document.getElementById('overall-accuracy').textContent = `${totalAccuracy.toFixed(1)}%`;
            
            const sortedByAccuracy = [...validAccuracyTopics].sort((a, b) => b.accuracy - a.accuracy);
            const strengths = sortedByAccuracy.slice(0, 3);
            const weaknesses = sortedByAccuracy.slice(-3).reverse();

            const strengthsList = document.getElementById('strengths-list');
            strengthsList.innerHTML = '';
            strengths.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-green-50 p-3 rounded-lg';
                li.innerHTML = `<span class="font-medium text-gray-700">${item.topic}</span><span class="font-bold text-green-600">${item.accuracy.toFixed(1)}%</span>`;
                strengthsList.appendChild(li);
            });

            const weaknessesList = document.getElementById('weaknesses-list');
            weaknessesList.innerHTML = '';
            weaknesses.forEach(item => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-red-50 p-3 rounded-lg';
                li.innerHTML = `<span class="font-medium text-gray-700">${item.topic}</span><span class="font-bold text-red-600">${item.accuracy.toFixed(1)}%</span>`;
                weaknessesList.appendChild(li);
            });
        }

        let performanceChartInstance = null;
        function renderPerformanceChart(examType) {
            const ctx = document.getElementById('performanceChart').getContext('2d');
            if (performanceChartInstance) {
                performanceChartInstance.destroy();
            }

            let chartData, chartLabel, pointBgColor, borderColor, yAxisLabel;
            
            const sortedMocks = [...progressData.mockAnalysis].sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);

            if (examType === 'cat') {
                const catMocks = sortedMocks.filter(d => d.exam === 'CAT' && !isNaN(parseFloat(d.overall.percentile)));
                chartData = catMocks.map(m => parseFloat(m.overall.percentile));
                chartLabel = 'CAT Percentile';
                pointBgColor = 'rgba(59, 130, 246, 1)';
                borderColor = 'rgba(59, 130, 246, 0.5)';
                yAxisLabel = 'Percentile (%)';
            } else {
                const sscMocks = sortedMocks.filter(d => d.exam === 'SSC CGL' && !isNaN(parseInt(d.overall.totalScore)));
                chartData = sscMocks.map(m => m.overall.totalScore);
                chartLabel = 'SSC CGL Score';
                pointBgColor = 'rgba(13, 148, 136, 1)';
                borderColor = 'rgba(13, 148, 136, 0.5)';
                yAxisLabel = 'Raw Score';
            }
            
            const labels = Array.from({ length: chartData.length }, (_, i) => `Mock ${i + 1}`);

            performanceChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartLabel,
                        data: chartData,
                        fill: true,
                        backgroundColor: (context) => {
                           const chart = context.chart;
                           const {ctx, chartArea} = chart;
                           if(!chartArea){ return null}
                           const gradient = ctx.createLinearGradient(0, chartArea.bottom, 0, chartArea.top);
                           gradient.addColorStop(0, 'rgba(255, 255, 255, 0)');
                           gradient.addColorStop(1, examType === 'cat' ? 'rgba(59, 130, 246, 0.2)' : 'rgba(13, 148, 136, 0.2)');
                           return gradient;
                        },
                        borderColor: borderColor,
                        pointBackgroundColor: pointBgColor,
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: pointBgColor,
                        tension: 0.3,
                        borderWidth: 2,
                        pointRadius: 5,
                        pointHoverRadius: 7,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: false,
                            title: {
                                display: true,
                                text: yAxisLabel,
                                font: { weight: 'bold' }
                            }
                        },
                        x: {
                             title: {
                                display: true,
                                text: 'Mock Test Instance',
                                font: { weight: 'bold' }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            enabled: true,
                            backgroundColor: '#000',
                            titleFont: { size: 14, weight: 'bold' },
                            bodyFont: { size: 12 },
                            padding: 10,
                            cornerRadius: 4,
                            displayColors: false,
                        }
                    }
                }
            });
        }
        
        window.showMockDetail = (id) => {
            const mock = progressData.mockAnalysis.find(m => m.id === id);
            if (!mock) return;
            document.getElementById('mock-detail-modal').classList.remove('hidden');
            document.getElementById('mock-detail-title').textContent = `${mock.exam} Mock Analysis`;
            document.getElementById('mock-detail-date').textContent = `Date: ${mock.date}`;
            document.getElementById('mock-detail-percentile').textContent = `Percentile: ${mock.overall.percentile}%`;
            document.getElementById('mock-detail-rank').textContent = `Rank: ${mock.overall.rank}`;
            document.getElementById('mock-detail-score').textContent = `Overall Score: ${mock.overall.totalScore} / ${mock.overall.totalPossibleScore}`;
            document.getElementById('mock-detail-accuracy').textContent = `Overall Accuracy: ${mock.overall.accuracy.toFixed(1)}%`;
            document.getElementById('mock-detail-edit-btn').onclick = () => {
                window.closeMockDetail();
                window.editMockAnalysis(id);
            };

            const sectionsContainer = document.getElementById('mock-detail-sections');
            sectionsContainer.innerHTML = '';
            
            const table = document.createElement('table');
            table.className = 'w-full text-sm text-left text-gray-500';
            table.innerHTML = `
                <thead class="text-xs text-gray-700 uppercase bg-gray-100">
                    <tr>
                        <th scope="col" class="px-6 py-3">Subject</th>
                        <th scope="col" class="px-6 py-3">Total Q</th>
                        <th scope="col" class="px-6 py-3">Attempted</th>
                        <th scope="col" class="px-6 py-3">Correct</th>
                        <th scope="col" class="px-6 py-3">Incorrect</th>
                        <th scope="col" class="px-6 py-3">Skipped</th>
                        <th scope="col" class="px-6 py-3">Score</th>
                        <th scope="col" class="px-6 py-3">Accuracy</th>
                        <th scope="col" class="px-6 py-3">Score %</th>
                    </tr>
                </thead>
                <tbody>
                </tbody>
            `;
            const tbody = table.querySelector('tbody');

            let sectionsToShow = [];
            if (mock.exam === 'CAT') {
                sectionsToShow = ['varc', 'qa', 'lr'];
            } else {
                sectionsToShow = ['gk', 'varc', 'qa', 'lr'];
            }

            sectionsToShow.forEach(section => {
                const sectionData = mock[section];
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                row.innerHTML = `
                    <td class="px-6 py-4 font-semibold text-gray-900">${section.toUpperCase()}</td>
                    <td class="px-6 py-4">${sectionData.totalQuestions}</td>
                    <td class="px-6 py-4">${sectionData.attempted}</td>
                    <td class="px-6 py-4 text-green-600 font-semibold">${sectionData.correct}</td>
                    <td class="px-6 py-4 text-red-600 font-semibold">${sectionData.incorrect}</td>
                    <td class="px-6 py-4 text-gray-500 font-semibold">${sectionData.skipped}</td>
                    <td class="px-6 py-4">${sectionData.score.toFixed(2)}</td>
                    <td class="px-6 py-4">${sectionData.accuracy.toFixed(1)}%</td>
                    <td class="px-6 py-4">${sectionData.scorePercentage.toFixed(1)}%</td>
                `;
                tbody.appendChild(row);
            });
            sectionsContainer.appendChild(table);
        };
        window.closeMockDetail = () => document.getElementById('mock-detail-modal').classList.add('hidden');
        
        function populateMockAnalysisTable(examType = 'all') {
            const tbody = document.getElementById('mock-analysis-table');
            tbody.innerHTML = '';
            let filteredData = progressData.mockAnalysis;
            if (examType !== 'all') {
                 filteredData = progressData.mockAnalysis.filter(mock => mock.exam === examType);
            }
            const sortedData = [...filteredData].sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
            const mockCounts = {};

            sortedData.forEach(mock => {
                let mockName;
                if (mock.exam === 'CAT') {
                    mockCounts.CAT = (mockCounts.CAT || 0) + 1;
                    mockName = `CAT ${mockCounts.CAT}`;
                } else if (mock.exam === 'SSC CGL') {
                    const tierKey = mock.tier;
                    mockCounts[tierKey] = (mockCounts[tierKey] || 0) + 1;
                    mockName = `SSC CGL Tier ${mock.tier.slice(-1)} ${mockCounts[tierKey]}`;
                }
                
                const row = document.createElement('tr');
                row.className = 'bg-white border-b cursor-pointer hover:bg-gray-50 transition-colors';
                row.onclick = () => showMockDetail(mock.id);
                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900 whitespace-nowrap">${mock.date}</td>
                    <td class="px-6 py-4">${mockName}</td>
                    <td class="px-6 py-4 font-semibold">${mock.overall.totalScore} / ${mock.overall.totalPossibleScore}</td>
                    <td class="px-6 py-4 text-center space-x-2 whitespace-nowrap">
                        <button onclick="event.stopPropagation(); editMockAnalysis('${mock.id}')" class="text-blue-600 hover:text-blue-800 transition-colors">✏️ Edit</button>
                        <button onclick="event.stopPropagation(); deleteData('${mock.id}', 'mock_analysis')" class="text-red-600 hover:text-red-800 transition-colors">❌ Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function populateStudyPlanTable() {
            const tbody = document.getElementById('study-plan-table');
            tbody.innerHTML = '';
            const sortedData = [...progressData.studyPlan].sort((a,b) => b.timestamp.seconds - a.timestamp.seconds);
            sortedData.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                let statusClass = '';
                if (item.status === 'Completed') statusClass = 'text-green-600 bg-green-100';
                else if (item.status === 'In Progress') statusClass = 'text-yellow-600 bg-yellow-100';
                else statusClass = 'text-gray-500 bg-gray-100';

                row.innerHTML = `
                    <td class="px-6 py-4">${item.week}</td>
                    <td class="px-6 py-4">${item.subject}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${item.topic}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${statusClass}">${item.status}</span></td>
                    <td class="px-6 py-4 text-center space-x-2 whitespace-nowrap">
                        <button onclick="editStudyPlan('${item.id}')" class="text-blue-600 hover:text-blue-800 transition-colors">✏️ Edit</button>
                        <button onclick="deleteData('${item.id}', 'study_plan')" class="text-red-600 hover:text-red-800 transition-colors">❌ Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function populateTopicAccuracyTable() {
            const tbody = document.getElementById('topic-accuracy-table');
            tbody.innerHTML = '';
            const validTopics = progressData.topicAccuracy.filter(t => t.attempted > 0).sort((a,b) => b.accuracy - a.accuracy);
            validTopics.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'bg-white border-b';
                const accuracyColor = item.accuracy >= 85 ? 'text-green-600' : item.accuracy >= 70 ? 'text-yellow-600' : 'text-red-600';

                row.innerHTML = `
                    <td class="px-6 py-4 font-medium text-gray-900">${item.topic}</td>
                    <td class="px-6 py-4 font-bold ${accuracyColor}">${item.accuracy.toFixed(1)}%</td>
                    <td class="px-6 py-4 text-center space-x-2 whitespace-now-wrap">
                        <button onclick="editTopicAccuracy('${item.id}')" class="text-blue-600 hover:text-blue-800 transition-colors">✏️ Edit</button>
                        <button onclick="deleteData('${item.id}', 'topic_accuracy')" class="text-red-600 hover:text-red-800 transition-colors">❌ Delete</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderSyllabus() {
            const syllabusContainer = document.getElementById('syllabus-content');
            syllabusContainer.innerHTML = '';

            const renderExam = (examKey, examData) => {
                const examDetails = document.createElement('details');
                examDetails.className = 'mb-6 p-4 rounded-lg bg-white shadow-md';
                const examSummary = document.createElement('summary');
                examSummary.className = 'text-xl font-bold cursor-pointer text-gray-800';
                examSummary.textContent = examData.name;
                examDetails.appendChild(examSummary);

                const subjectsContainer = document.createElement('div');
                subjectsContainer.className = 'mt-4 ml-4';
                
                examData.subjects.forEach(subject => {
                    const subjectButton = document.createElement('button');
                    subjectButton.className = 'w-full text-left p-3 rounded-lg bg-gray-50 hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors flex justify-between items-center text-lg font-semibold cursor-pointer text-gray-700 mt-2';
                    subjectButton.innerHTML = `<span>${subject.name}</span> <span class="syllabus-icon transform transition-transform duration-200">▶️</span>`;
                    subjectsContainer.appendChild(subjectButton);
                    
                    const topicGroupsContainer = document.createElement('div');
                    topicGroupsContainer.className = 'syllabus-subject-content hidden mt-2 ml-4 p-3 space-y-2 rounded-lg bg-gray-100';
                    
                    subject.topicGroups.forEach(group => {
                        const groupButton = document.createElement('button');
                        groupButton.className = 'w-full text-left p-2 rounded-lg bg-gray-100 hover:bg-gray-200 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors flex justify-between items-center text-base font-medium text-gray-600';
                        groupButton.innerHTML = `<span>${group.heading}</span> <span class="syllabus-icon transform transition-transform duration-200">▶️</span>`;
                        topicGroupsContainer.appendChild(groupButton);

                        const topicsList = document.createElement('ul');
                        topicsList.className = 'syllabus-topic-group-content hidden mt-2 space-y-1 ml-4 list-disc list-inside';
                        group.topics.forEach(topic => {
                            const topicItem = document.createElement('li');
                            topicItem.className = 'syllabus-topic-item text-gray-500';
                            topicItem.textContent = topic;
                            topicsList.appendChild(topicItem);
                        });
                        topicGroupsContainer.appendChild(topicsList);

                        groupButton.addEventListener('click', () => {
                            topicsList.classList.toggle('hidden');
                            groupButton.querySelector('.syllabus-icon').classList.toggle('rotate-90');
                        });
                    });

                    subjectButton.addEventListener('click', () => {
                        topicGroupsContainer.classList.toggle('hidden');
                        subjectButton.querySelector('.syllabus-icon').classList.toggle('rotate-90');
                    });
                    
                    subjectsContainer.appendChild(topicGroupsContainer);
                });
                
                examDetails.appendChild(subjectsContainer);
                syllabusContainer.appendChild(examDetails);
            };

            renderExam('cat', syllabusData.cat);
            renderExam('ssc_cgl', syllabusData.ssc_cgl);
        }

        window.toggleMockForm = (examType) => {
            document.getElementById('cat-fields').classList.add('hidden');
            document.getElementById('ssc-fields').classList.add('hidden');
            if (examType === 'CAT') {
                document.getElementById('cat-fields').classList.remove('hidden');
            } else {
                document.getElementById('ssc-fields').classList.remove('hidden');
            }
        }
        window.toggleSSCTier = (tier) => {
             document.getElementById('ssc-tier1-fields').classList.add('hidden');
             document.getElementById('ssc-tier2-fields').classList.add('hidden');
             if (tier === 'tier1') {
                 document.getElementById('ssc-tier1-fields').classList.remove('hidden');
             } else {
                 document.getElementById('ssc-tier2-fields').classList.remove('hidden');
             }
        }
        
        window.getAiAnalysis = async (mockId) => {
            const mock = progressData.mockAnalysis.find(m => m.id === mockId);
            if (!mock) return;

            const outputDiv = document.getElementById('mock-ai-analysis-output');
            const loadingDiv = document.getElementById('mock-ai-loading');
            outputDiv.innerHTML = '';
            outputDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');

            try {
                const systemPrompt = "Act as a world-class tutor and exam preparation expert for CAT and SSC CGL exams. Provide a concise, actionable analysis of the student's mock test performance. Highlight their strengths and weaknesses and give clear, strategic advice for improvement in a friendly tone.";
                const userQuery = `Analyze the following mock test results for a student preparing for the ${mock.exam} exam. The overall results are: Total Questions: ${mock.overall.totalQuestions}, Correct: ${mock.overall.correct}, Incorrect: ${mock.overall.incorrect}, Skipped: ${mock.overall.skipped}, Total Score: ${mock.overall.totalScore} / ${mock.overall.totalPossibleScore}, Accuracy: ${mock.overall.accuracy.toFixed(1)}%, Percentile: ${mock.overall.percentile}%, Rank: ${mock.overall.rank}. \n\nPlease provide a clear, actionable analysis of their performance.`;

                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{ parts: [{ text: userQuery }] }],
                    systemInstruction: {
                        parts: [{ text: systemPrompt }]
                    },
                };
                
                let response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result?.candidates?.[0]?.content?.parts?.[0]?.text;

                if (text) {
                    outputDiv.textContent = text;
                } else {
                    outputDiv.textContent = "Could not generate analysis. Please try again.";
                }

            } catch (e) {
                console.error("Gemini API error:", e);
                outputDiv.textContent = "An error occurred while getting the analysis. Please check the console for more details.";
            } finally {
                loadingDiv.classList.add('hidden');
                outputDiv.classList.remove('hidden');
            }
        };
    </script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Chosen Palette: "Soothing Sage" - A calming and focused theme with greens and warm greys. -->
    <!-- Application Structure Plan: A tab-based single-page application with "Dashboard", "Mock Analysis", "Study Plan", and "Syllabus" tabs. The 'Dashboard' provides a high-level summary with key metrics and a performance trend chart. The updated 'Mock Analysis' and 'Study Plan' pages now have dedicated buttons to open a single modal for adding/editing data. The 'Syllabus' section provides a hierarchical and searchable view of all exam topics. This new structure uses a modal-based approach to centralize all data entry (study, accuracy, and mock analysis), creating a cleaner, more intuitive user experience. The 'Add New Data' button on the Dashboard now opens the modal with all forms visible. -->
    <!-- Visualization & Content Choices: 
        - Overall Stats (Cards): Goal=Inform, Method=HTML/Tailwind, Interaction=None. Justification: Quick, scannable summary of key achievements.
        - Performance Trend (Line Chart): Goal=Change, Method=Chart.js Canvas, Interaction=Buttons to toggle between CAT/SSC data. Justification: The most effective way to visualize progress over time.
        - Strengths/Weaknesses (Lists): Goal=Organize, Method=HTML/Tailwind lists, Interaction=None. Justification: Clearly separates high and low-performing topics for focused study.
        - Data Tables (HTML): Goal=Compare/Organize, Method=HTML Tables with JS buttons for edit/delete. Interaction=Direct editing and deletion from table rows. Justification: Provides detailed, structured data for in-depth review and allows for quick, direct manipulation of records.
        - Syllabus (HTML/CSS & JavaScript): Goal=Organize/Inform, Method=JavaScript-driven buttons with hidden divs for multi-level expansion, and a search filter. Justification: Provides fine-grained control over content visibility, allowing the user to progressively reveal information without cluttering the interface.
        - Data Entry Modal: Goal=Collect & Update User Data, Method=HTML Forms in a JS-controlled modal. Interaction=Buttons to open modal, form submission to database, modal closure. Justification: A superior UI pattern for data entry that keeps the main page clean and focused, improving usability significantly. The single modal now handles all three types of data entry for consistency.
    -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8f9fa;
        }
        .nav-button {
            transition: all 0.3s ease;
        }
        .nav-button.active {
            background-color: #2c5282;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .card {
            background-color: white;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .chart-container {
            position: relative;
            width: 100%;
            max-width: 900px;
            margin-left: auto;
            margin-right: auto;
            height: 40vh;
            max-height: 450px;
        }
        .modal-content-container {
            position: relative;
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            max-width: 48rem; /* Equivalent to max-w-2xl */
            max-height: 80vh;
            overflow-y: auto;
            margin: auto;
        }
    </style>
</head>
<body class="text-gray-800">

    <div id="loading-indicator" class="flex justify-center items-center h-screen text-gray-500">
        Loading...
    </div>

    <div id="main-container" class="hidden container mx-auto p-4 md:p-8 max-w-7xl">

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-800">My Preparation Dashboard</h1>
            <p class="text-gray-600 mt-2">Tracking Progress for CAT & SSC CGL</p>
        </header>

        <nav class="flex justify-center bg-white p-2 rounded-full shadow-md mb-8 max-w-lg mx-auto">
            <button id="btn-dashboard" class="nav-button active flex-1 text-center py-2 px-4 rounded-full font-semibold">Dashboard</button>
            <button id="btn-analysis" class="nav-button flex-1 text-center py-2 px-4 rounded-full font-semibold">Mock Analysis</button>
            <button id="btn-plan" class="nav-button flex-1 text-center py-2 px-4 rounded-full font-semibold">Study Plan</button>
            <button id="btn-syllabus" class="nav-button flex-1 text-center py-2 px-4 rounded-full font-semibold">Syllabus</button>
        </nav>

        <main id="content-area">
            <!-- Dashboard View -->
            <section id="view-dashboard">
                <div class="text-center mb-8">
                     <h2 class="text-2xl font-bold text-gray-700">At a Glance</h2>
                     <p class="text-gray-500 mt-1">Here's your high-level progress summary.</p>
                </div>
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
                    <div class="card p-6 flex flex-col items-center justify-center text-center">
                        <span class="text-4xl font-bold text-blue-600" id="topics-completed">0</span>
                        <p class="mt-2 font-semibold text-gray-600">Topics Completed</p>
                    </div>
                    <div class="card p-6 flex flex-col items-center justify-center text-center">
                        <span class="text-4xl font-bold text-green-600" id="avg-cat-percentile">0.00%</span>
                        <p class="mt-2 font-semibold text-gray-600">Avg. CAT Percentile</p>
                    </div>
                    <div class="card p-6 flex flex-col items-center justify-center text-center">
                        <span class="text-4xl font-bold text-teal-600" id="avg-ssc-score">0</span>
                        <p class="mt-2 font-semibold text-gray-600">Avg. SSC CGL Score</p>
                    </div>
                     <div class="card p-6 flex flex-col items-center justify-center text-center">
                        <span class="text-4xl font-bold text-purple-600" id="overall-accuracy">0.0%</span>
                        <p class="mt-2 font-semibold text-gray-600">Overall Accuracy</p>
                    </div>
                </div>
                <div class="flex justify-center mb-8">
                    <button id="add-data-btn" onclick="openModal('all')" class="px-6 py-3 bg-blue-600 text-white rounded-lg font-bold shadow-lg hover:bg-blue-700 transition-colors">Add New Data</button>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 my-8">
                    <a href="https://www.aftergrad.in/dailyRC" target="_blank" class="block w-full text-center px-4 py-3 bg-white text-blue-600 rounded-lg font-bold shadow-md hover:bg-gray-50 transition-colors">
                        Daily RC 📖
                    </a>
                    <a href="https://www.aftergrad.in/attempt-past-year-paper" target="_blank" class="block w-full text-center px-4 py-3 bg-white text-blue-600 rounded-lg font-bold shadow-md hover:bg-gray-50 transition-colors">
                        Past Year Papers 📜
                    </a>
                </div>

                <div class="card p-4 md:p-6 mb-10">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-700 mb-2 sm:mb-0">Mock Performance Trend</h3>
                        <div class="flex space-x-2 bg-gray-100 p-1 rounded-md">
                            <button id="chart-btn-cat" class="px-3 py-1 text-sm font-semibold rounded-md bg-white text-blue-700 shadow">CAT</button>
                            <button id="chart-btn-ssc" class="px-3 py-1 text-sm font-semibold rounded-md text-gray-600">SSC CGL</button>
                        </div>
                    </div>
                     <p class="text-gray-500 mb-4 text-center sm:text-left">This chart shows your mock test scores over time. Use the buttons to switch between CAT (percentile) and SSC CGL (raw score) performance to visualize your improvement.</p>
                    <div class="chart-container">
                        <canvas id="performanceChart"></canvas>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">✅ Top Topics (Strengths)</h3>
                        <p class="text-gray-500 mb-4">These are your highest-performing topics based on accuracy. Keep reinforcing these concepts.</p>
                        <ul id="strengths-list" class="space-y-3"></ul>
                    </div>
                    <div class="card p-6">
                        <h3 class="text-xl font-bold text-gray-700 mb-4">🔎 Areas for Improvement</h3>
                         <p class="text-gray-500 mb-4">Focus your next study sessions on these topics to boost your scores. These have the lowest accuracy.</p>
                        <ul id="weaknesses-list" class="space-y-3"></ul>
                    </div>
                </div>
            </section>

            <!-- Mock Analysis View -->
            <section id="view-analysis" class="hidden">
                <div class="card p-4 md:p-6">
                     <div class="flex justify-between items-center mb-4">
                        <h2 class="text-2xl font-bold text-gray-700">Detailed Mock Test Analysis</h2>
                        <button id="btn-add-mock-data" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-lg hover:bg-blue-700 transition-colors">+ Add Data</button>
                    </div>
                     <div class="flex space-x-2 bg-gray-100 p-1 rounded-md max-w-sm mb-6">
                            <button id="analysis-btn-all" class="px-3 py-1 text-sm font-semibold rounded-md bg-white text-blue-700 shadow">All Exams</button>
                            <button id="analysis-btn-cat" class="px-3 py-1 text-sm font-semibold rounded-md text-gray-600">CAT</button>
                            <button id="analysis-btn-ssc" class="px-3 py-1 text-sm font-semibold rounded-md text-gray-600">SSC CGL</button>
                        </div>
                    <p class="text-gray-500 mt-1 mb-6">Review each mock test to understand your performance patterns, identify common mistakes, and refine your test-taking strategy.</p>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm text-left text-gray-500">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                <tr>
                                    <th scope="col" class="px-6 py-3">Date</th>
                                    <th scope="col" class="px-6 py-3">Exam</th>
                                    <th scope="col" class="px-6 py-3">Score</th>
                                    <th scope="col" class="px-6 py-3 text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="mock-analysis-table">
                            </tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Study Plan View -->
            <section id="view-plan" class="hidden">
                 <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                    <div class="card p-4 md:p-6">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-700">Weekly Study Plan</h2>
                            <button id="btn-add-study-data" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-lg hover:bg-blue-700 transition-colors">+ Add Data</button>
                        </div>
                        <p class="text-gray-500 mt-1 mb-6">This is your roadmap. Track the status of each topic to ensure you stay on schedule with your preparation.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Week</th>
                                        <th scope="col" class="px-6 py-3">Subject</th>
                                        <th scope="col" class="px-6 py-3">Topic</th>
                                        <th scope="col" class="px-6 py-3">Status</th>
                                        <th scope="col" class="px-6 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="study-plan-table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                     <div class="card p-4 md:p-6">
                         <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold text-gray-700">Topic-wise Accuracy</h2>
                            <button id="btn-add-accuracy-data" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-bold shadow-lg hover:bg-blue-700 transition-colors">+ Add Data</button>
                        </div>
                        <p class="text-gray-500 mt-1 mb-6">Compare your plan with your performance. This detailed breakdown helps you decide where to focus your revision efforts.</p>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left text-gray-500">
                                <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                    <tr>
                                        <th scope="col" class="px-6 py-3">Topic</th>
                                        <th scope="col" class="px-6 py-3">Accuracy</th>
                                        <th scope="col" class="px-6 py-3 text-center">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="topic-accuracy-table">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>
            
            <!-- Syllabus View -->
            <section id="view-syllabus" class="hidden">
                <div class="card p-6">
                    <h2 class="text-2xl font-bold text-gray-700 text-center mb-2">Complete Syllabus</h2>
                    <p class="text-gray-500 mb-6 text-center">Browse all topics for both exams or use the search bar to find a specific one.</p>
                    <div class="mb-6">
                        <input type="text" id="syllabus-search" placeholder="Search for a topic..." class="w-full p-3 border rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors">
                    </div>
                    <div id="syllabus-content"></div>
                </div>
            </section>
        </main>
    </div>

    <!-- Data Entry Modal -->
    <div id="data-entry-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="modal-content-container">
            <button id="modal-close-btn" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors text-2xl font-bold">✖️</button>
            <div id="message-box" class="hidden"></div>
            <div id="data-entry-content" class="grid grid-cols-1 gap-8">
                <div id="study-form-container" class="space-y-4">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><span class="mr-2">📝</span><span id="study-form-title">Add Study Plan Entry</span></h3>
                    <form id="study-form" onsubmit="saveStudyData(event)">
                        <input type="hidden" id="studyDocId" value="">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Topic</label>
                            <input type="text" id="studyTopic" list="syllabus-topics" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Subject</label>
                            <input type="text" id="studySubject" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Week</label>
                            <input type="text" id="studyWeek" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Status</label>
                            <select id="studyStatus" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                <option value="In Progress">In Progress</option>
                                <option value="Completed">Completed</option>
                                <option value="Not Started">Not Started</option>
                            </select>
                        </div>
                        <button type="submit" id="save-study-btn" class="w-full bg-blue-600 text-white p-2 rounded-md font-bold hover:bg-blue-700 transition-colors">Save Study Data</button>
                    </form>
                </div>
                <div id="accuracy-form-container" class="space-y-4">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><span class="mr-2">🎯</span><span id="accuracy-form-title">Add Topic Accuracy</span></h3>
                    <form id="accuracy-form" onsubmit="saveTopicAccuracy(event)">
                        <input type="hidden" id="accuracyDocId" value="">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Topic</label>
                            <input type="text" id="accuracyTopic" list="syllabus-topics" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Questions Attempted</label>
                            <input type="number" id="accuracyAttempted" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Correct Questions</label>
                            <input type="number" id="accuracyCorrect" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                        </div>
                        <button type="submit" id="save-accuracy-btn" class="w-full bg-blue-600 text-white p-2 rounded-md font-bold hover:bg-blue-700 transition-colors">Save Accuracy Data</button>
                    </form>
                </div>
                <div id="mock-form-container" class="space-y-4">
                    <h3 class="text-xl font-bold mb-4 flex items-center"><span class="mr-2">📊</span><span id="mock-form-title">Add Mock Test Entry</span></h3>
                    <form id="mock-form" onsubmit="saveMockData(event)">
                        <input type="hidden" id="mockDocId" value="">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2">Exam Type</label>
                            <select id="mockExamType" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                <option value="CAT">CAT</option>
                                <option value="SSC CGL">SSC CGL</option>
                            </select>
                        </div>
                         <!-- CAT Fields -->
                        <div id="cat-fields" class="space-y-4 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                <!-- VARC -->
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">VARC</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="varcTotalQuestions" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="varcAttempted" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="varcCorrect" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="varcIncorrect" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="varcSkipped" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="varcScore" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="varcAccuracy" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="varcScorePercentage" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                                <!-- QA -->
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">QA</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="qaTotalQuestions" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="qaAttempted" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="qaCorrect" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="qaIncorrect" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="qaSkipped" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="qaScore" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="qaAccuracy" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="qaScorePercentage" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                                <!-- LR -->
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">LR</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="lrTotalQuestions" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="lrAttempted" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="lrCorrect" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="lrIncorrect" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="lrSkipped" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="lrScore" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="lrAccuracy" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="lrScorePercentage" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                            </div>
                        </div>
                        <!-- SSC CGL Fields -->
                        <div id="ssc-fields" class="space-y-4 hidden">
                            <div class="mb-4">
                                <label class="block text-gray-700 text-sm font-bold mb-2">Tier</label>
                                <select id="sscTier" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <option value="tier1">Tier 1</option>
                                    <option value="tier2">Tier 2</option>
                                </select>
                            </div>
                            <div id="ssc-tier1-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">General Knowledge</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="ssc_gkTotalQuestions_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="ssc_gkAttempted_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="ssc_gkCorrect_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="ssc_gkIncorrect_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="ssc_gkSkipped_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="ssc_gkScore_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="ssc_gkAccuracy_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="ssc_gkScorePercentage_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">English Language</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="ssc_varcTotalQuestions_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="ssc_varcAttempted_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="ssc_varcCorrect_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="ssc_varcIncorrect_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="ssc_varcSkipped_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="ssc_varcScore_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="ssc_varcAccuracy_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="ssc_varcScorePercentage_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">Quantitative Aptitude</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="ssc_qaTotalQuestions_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="ssc_qaAttempted_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="ssc_qaCorrect_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="ssc_qaIncorrect_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="ssc_qaSkipped_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="ssc_qaScore_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="ssc_qaAccuracy_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="ssc_qaScorePercentage_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">Logical Reasoning</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="ssc_lrTotalQuestions_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="ssc_lrAttempted_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="ssc_lrCorrect_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="ssc_lrIncorrect_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="ssc_lrSkipped_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="ssc_lrScore_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="ssc_lrAccuracy_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="ssc_lrScorePercentage_tier1" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                            </div>
                            </div>
                            <div id="ssc-tier2-fields" class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">General Knowledge</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="ssc_gkTotalQuestions_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="ssc_gkAttempted_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="ssc_gkCorrect_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="ssc_gkIncorrect_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="ssc_gkSkipped_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="ssc_gkScore_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="ssc_gkAccuracy_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="ssc_gkScorePercentage_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">English Language</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="ssc_varcTotalQuestions_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="ssc_varcAttempted_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="ssc_varcCorrect_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="ssc_varcIncorrect_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="ssc_varcSkipped_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="ssc_varcScore_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="ssc_varcAccuracy_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="ssc_varcScorePercentage_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">Quantitative Aptitude</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="ssc_qaTotalQuestions_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="ssc_qaAttempted_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="ssc_qaCorrect_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="ssc_qaIncorrect_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="ssc_qaSkipped_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="ssc_qaScore_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="ssc_qaAccuracy_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="ssc_qaScorePercentage_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                                <div class="p-4 border rounded-lg bg-gray-50">
                                    <h4 class="font-semibold mb-2">Logical Reasoning</h4>
                                    <label class="block text-sm">Total Questions</label>
                                    <input type="number" id="ssc_lrTotalQuestions_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Attempted</label>
                                    <input type="number" id="ssc_lrAttempted_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Correct</label>
                                    <input type="number" id="ssc_lrCorrect_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Incorrect</label>
                                    <input type="number" id="ssc_lrIncorrect_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Skipped</label>
                                    <input type="number" id="ssc_lrSkipped_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score</label>
                                    <input type="number" id="ssc_lrScore_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Accuracy %</label>
                                    <input type="number" id="ssc_lrAccuracy_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                    <label class="block text-sm">Score %</label>
                                    <input type="number" id="ssc_lrScorePercentage_tier2" class="w-full p-2 rounded-md border mb-2 focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </div>
                            </div>
                        </div>
                        <!-- Overall Mock Data -->
                        <div class="mt-8 space-y-4">
                            <h4 class="font-bold text-lg mb-2">Overall Performance</h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <label class="block">Overall Accuracy
                                    <input type="number" id="sscOverallAccuracy" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </label>
                                <label class="block">Overall Score
                                    <input type="number" id="overallScore" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </label>
                                <label class="block">Overall Possible Score
                                    <input type="number" id="overallPossibleScore" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </label>
                                <label class="block">Overall Percentile
                                    <input type="number" id="overallPercentile" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </label>
                                <label class="block">Overall Rank
                                    <input type="text" id="overallRank" class="w-full p-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 transition-colors" required>
                                </label>
                            </div>
                        </div>
                        <button type="submit" id="save-mock-btn" class="w-full bg-blue-600 text-white p-2 mt-6 rounded-md font-bold hover:bg-blue-700 transition-colors">Save Mock Data</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <!-- Mock Details Modal -->
    <div id="mock-detail-modal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full flex items-center justify-center z-50">
        <div class="modal-content-container">
            <button onclick="closeMockDetail()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800 transition-colors text-2xl font-bold">✖️</button>
            <h3 id="mock-detail-title" class="text-2xl font-bold mb-4"></h3>
            <p id="mock-detail-date" class="text-sm text-gray-500 mb-4"></p>
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6">
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Overall Score</p>
                    <p id="mock-detail-score" class="text-lg font-bold"></p>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Overall Accuracy</p>
                    <p id="mock-detail-accuracy" class="text-lg font-bold"></p>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Percentile</p>
                    <p id="mock-detail-percentile" class="text-lg font-bold"></p>
                </div>
                <div class="bg-gray-100 p-4 rounded-lg">
                    <p class="text-sm text-gray-600">Rank</p>
                    <p class="text-lg font-bold" id="mock-detail-rank"></p>
                </div>
            </div>
            <h4 class="font-bold text-xl mb-4">Sectional Breakdown</h4>
            <div id="mock-detail-sections" class="overflow-x-auto"></div>
            <div class="mt-6 flex justify-between items-center">
                <button id="mock-ai-analysis-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md font-bold hover:bg-blue-700 transition-colors">Get AI Analysis ✨</button>
                <button id="mock-detail-edit-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md font-bold hover:bg-blue-700 transition-colors">Edit This Entry</button>
            </div>
            <div id="mock-ai-loading" class="hidden mt-6 text-center text-gray-500 animate-pulse">
                Analyzing your data... please wait.
            </div>
            <div id="mock-ai-analysis-output" class="hidden mt-6 p-4 bg-gray-50 rounded-lg text-gray-700 whitespace-pre-wrap"></div>
        </div>
    </div>
    <datalist id="syllabus-topics"></datalist>
</body>
</html>